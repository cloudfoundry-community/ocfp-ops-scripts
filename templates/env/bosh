#!/usr/bin/env bash

[[ -n ${OCFP_IAAS:-} ]]     || fail "OCFP_IAAS     must be set and exported."
[[ -n ${OCFP_REGION:-} ]]   || fail "OCFP_REGION   must be set and exported."
[[ -n ${OCFP_ENV_TYPE:-} ]] || fail "OCFP_ENV_TYPE must be set and exported."
[[ -n ${OCFP_ENV_NAME:-} ]] || fail "OCFP_ENV_NAME must be set and exported."

usage() {
  echo -e "$(cat <<EOT

USAGE

  $ export OCFP_IAAS="..." OCFP_REGION="..." OCFP_ENV_TYPE="..." OCFP_ENV_NAME="..." 
  $ ${0}

EOT
)" >&2
exit 1
}

fail() { echo -e "$*" >&2 ; exit 1 ; }

shift || usage

cat <<-YAML
---
kit:
  name: bosh
  version: 2.2.6-rc.4
  features:
  - (( append ))
  - ${OCFP_IAAS}
  - external-db-vault
  - bosh-dns-health-check
  - netop-access
  - sysop-access
YAML

case ${OCFP_ENV_NAME} in
  (*mgmt*) echo "  - proto # legacy name" ;;
  (*) true ;;
esac

case ${OCFP_IAAS} in
  (aws) echo "  - s3-blobstore" ;;
  (gcp) echo "  - gcp-blobstore" ;;
  (azure) echo "  - azure-blobstore" ;;
  (*) true ;;
esac

cat <<-YAML

genesis:
  env: ${OCFP_ENV_NAME}
  min_version: 2.8.5
YAML

case ${OCFP_VAULT_PREFIX} in
  (secret/*) echo "  secrets_mount: \"${OCFP_VAULT_PREFIX}\"" ;;
  (*) true ;;
esac

cat <<-YAML

meta:
  vault_tf: (( concat meta.vault_aws "/${OCFP_REGION//-/\/}" ))

params:
  trusted_certs:
  - (( vault meta.vault_aws "/certs/rds:ca" )) # RDS Global CA
  - (( vault meta.vault_aws "/certs/org:ca" )) # Organizaion CA

  subnet_addr: (( vault meta.vault_tf "/aws/subnets/ocfp/1:cidr_block" )) # First OCFP Network
  default_gateway: (( vault meta.vault_tf "/aws/ocfp/mgmt/bosh:gateway" )) # tf: cidrhost(ocfp/1, 1)
  dns: 
    - (( vault meta.vault_tf "ocfp/mgmt/bosh:dns" )) #cidrhost(ocfp/1, 2)
  static_ip: (( vault meta.vault_tf "ocfp/mgmt/bosh:ip" )) #cidrhost(ocfp/1, 4) -> should be `.4` - validate, this might need to be ,5 if it computes from 0
  
  aws_region: "${OCFP_REGION}"
  
  aws_default_sgs:
    - (( vault meta.vault_tf "aws/sgs/default:id" ))
    - (( vault meta.vault_tf "aws/sgs/${OCFP_ENV_TYPE}:id" ))
  
YAML

case ${OCFP_ENV_NAME} in
  (*-mgmt-*)
    cat <<-YAML
  aws_subnet_id: (( vault meta.vault_tf "aws/subnets/ocfp/1:id" ))
  
  aws_security_groups: (default,bosh)
    - (( vault meta.vault_tf "aws/sgs/default:id" ))
    - (( vault meta.vault_tf "aws/sgs/${OCFP_ENV_TYPE}:id" ))

YAML
    ;;
  (*) true ;; # ocf env (eg. non create-env bosh) does not use these
esac

cat <<-YAML
  s3_blobstore_bucket: (( vault meta.vault_tf "/ocfp/${OCFP_ENV_TYPE}/s3/bosh:name" ))
  s3_blobstore_region: ${OCFP_REGION} # TODO: check if needs to be set in ^^^
  
  dns_cache: true # DNS Caching (for runtime config)

YAML


